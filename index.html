<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dan's Logic Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        
        /* --- UTILS --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-content { background-color: #1e293b; padding: 2rem; border-radius: 1rem; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto; border: 1px solid #334155; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .tab-btn { transition: all 0.2s; opacity: 0.5; border-bottom: 4px solid transparent; }
        .tab-btn:hover { opacity: 0.8; background-color: rgba(255,255,255,0.05); }
        .tab-btn.active { opacity: 1; border-bottom: 4px solid #6366f1; background-color: rgba(99, 102, 241, 0.1); color: #fff; }
        
        /* Status Animations */
        @keyframes flashRed { 0%, 100% { color: #94a3b8; } 50% { color: #f43f5e; } }
        .status-error { animation: flashRed 1s ease-in-out; font-weight: bold; color: #f43f5e !important; }

        /* --- PUZZLE STYLES --- */
        .jug-container { position: relative; width: 100px; background: #334155; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; border: 4px solid #94a3b8; border-top: none; margin: 0 auto; overflow: hidden; transition: all 0.3s; cursor: pointer; }
        .jug-water { position: absolute; bottom: 0; left: 0; width: 100%; background-color: #3b82f6; transition: height 0.5s ease-in-out; opacity: 0.8; }
        .jug-selected { border-color: #fbbf24; box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }

        .bulb-on { background-color: #fcd34d; color: #854d0e; box-shadow: 0 0 20px #fcd34d; border-color: #fbbf24; }
        .bulb-off { background-color: #1e293b; color: #64748b; border-color: #475569; }
        .heat-high { border: 3px solid #ea580c; box-shadow: 0 0 15px rgba(234, 88, 12, 0.5); }
        .heat-med { border: 3px solid #fbbf24; }
        .heat-low { border: 1px solid #475569; }

        .horse { width: 40px; height: 40px; border-radius: 8px; background-color: #be185d; color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; cursor: grab; transition: all 0.2s; user-select: none; border: 2px solid #fbcfe8; z-index: 10; }
        .horse:active { cursor: grabbing; transform: scale(1.1); }
        .horse:hover { transform: scale(1.1) rotate(3deg); background-color: #9d174d; }
        .track-slot { width: 50px; height: 60px; border: 2px dashed #64748b; border-radius: 8px; display: flex; align-items: center; justify-content: center; background-color: #334155; transition: background-color 0.2s; }
        .grid-slot { width: 45px; height: 45px; border: 1px solid #475569; border-radius: 6px; display: flex; align-items: center; justify-content: center; background-color: #1e293b; }
        
        .ball { width: 40px; height: 40px; border-radius: 50%; background-color: #4f46e5; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; transition: transform 0.1s; }
        .pan { min-height: 100px; border: 2px dashed #475569; border-radius: 8px; background-color: #1e293b; display: flex; flex-wrap: wrap; gap: 5px; padding: 10px; transition: all 0.3s; }
        .scale-result { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center; }
        .left-heavy { transform: rotate(-5deg); border-color: #ef4444; } 
        .right-heavy { transform: rotate(5deg); border-color: #ef4444; }
        
        .box-btn { transition: all 0.2s; cursor: pointer; }
        .box-btn:hover:not(:disabled) { transform: translateY(-3px); border-color: #818cf8; }
        .quantum-active { animation: pulse-glow 3s infinite; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 10px rgba(99, 102, 241, 0.1); } 50% { box-shadow: 0 0 25px rgba(99, 102, 241, 0.3); } }

        /* --- RIVER STYLES --- */
        .person { width: 50px; height: 60px; border-radius: 8px; background-color: #059669; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; border: 2px solid #34d399; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .person:hover { transform: translateY(-3px); box-shadow: 0 6px 8px rgba(0,0,0,0.4); }
        .river-container { position: relative; height: 220px; background: repeating-linear-gradient(45deg, #1e3a8a, #1e3a8a 10px, #172554 10px, #172554 20px); border-radius: 12px; border: 2px solid #3b82f6; overflow: hidden; display: flex; justify-content: space-between; }
        .bank { width: 35%; background-color: #334155; border-right: 4px solid #475569; z-index: 5; display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(3, 1fr); gap: 10px; padding: 15px; align-items: center; justify-items: center; }
        .bank.right { border-right: none; border-left: 4px solid #475569; }
        .boat { width: 140px; height: 70px; background-color: #7c2d12; border-radius: 0 0 50px 50px; border: 3px solid #b45309; position: absolute; bottom: 20px; transition: left 0.8s ease-in-out; display: flex; justify-content: center; items-start; gap: 10px; padding-top: 8px; z-index: 10; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .boat::after { content: "BOAT"; font-size: 10px; color: #fdba74; position: absolute; bottom: 5px; }
        .shake-fail { animation: shake 0.4s ease-in-out; border: 2px solid #f43f5e; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* --- GRAPH STYLES --- */
        #graph-canvas, #spider-canvas { background-color: #1e293b; border-radius: 12px; border: 2px solid #475569; cursor: crosshair; display: block; margin: 0 auto; }
        
        /* Sidebar & Nav */
        .nav-item { padding: 12px 16px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s; border-left: 3px solid transparent; color: #94a3b8; font-weight: 600; font-size: 0.9rem; }
        .nav-item:hover { background-color: rgba(255,255,255,0.03); color: #e2e8f0; }
        .nav-item.active { background-color: rgba(99, 102, 241, 0.1); border-left: 3px solid #6366f1; color: #fff; }
        .nav-icon { margin-left: auto; font-size: 1rem; }

        /* Mobile Nav */
        .mobile-tab { padding: 10px 16px; white-space: nowrap; font-weight: bold; font-size: 0.85rem; color: #94a3b8; border-bottom: 2px solid transparent; display: flex; align-items: center; gap: 5px; }
        .mobile-tab.active { border-bottom: 2px solid #6366f1; color: #fff; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden bg-slate-900 text-slate-200">

    <aside class="hidden md:flex flex-col w-64 bg-slate-800 border-r border-slate-700 h-full shrink-0">
        <div class="p-6 border-b border-slate-700 cursor-pointer" onclick="switchTab('about')">
            <div class="flex items-center space-x-2 mb-1">
                <span class="text-2xl">üß†</span>
                <h1 class="text-lg font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">Dan's Logic Hub</h1>
            </div>
            <div class="text-xs text-slate-500 uppercase tracking-widest font-bold">v1.0.5</div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4" id="desktop-nav">
            </nav>

        <div class="p-4 border-t border-slate-700 bg-slate-900/50">
            <div class="flex justify-between items-center mb-3">
                <div id="global-timer-desktop" onclick="toggleTimer()" class="cursor-pointer text-slate-500 font-mono font-bold text-sm bg-slate-800 px-2 py-1 rounded border border-slate-600 hover:text-white hover:border-slate-500 transition-all select-none w-20 text-center" title="Click to show/hide time">‚è±Ô∏è Time</div>
                <div id="user-status-desktop" class="text-xs font-bold text-slate-400 cursor-pointer hover:text-white" onclick="openModal('modal-login')">Login</div>
            </div>
            <p class="text-slate-600 text-xs italic text-center">"Together Sharpening our Minds"</p>
        </div>
    </aside>

    <div class="md:hidden flex flex-col bg-slate-800 border-b border-slate-700 z-20">
        <div class="flex justify-between items-center px-4 h-14">
            <div class="flex items-center space-x-2" onclick="switchTab('about')">
                <span class="text-xl">üß†</span>
                <h1 class="font-bold text-white">Dan's Logic Hub</h1>
            </div>
            <div class="flex items-center space-x-3">
                <div id="global-timer-mobile" onclick="toggleTimer()" class="cursor-pointer text-slate-500 font-mono font-bold text-xs bg-slate-900 px-2 py-1 rounded border border-slate-600 w-16 text-center">‚è±Ô∏è</div>
                <button id="user-status-mobile" onclick="openModal('modal-login')" class="text-slate-400 hover:text-white">üë§</button>
            </div>
        </div>
        <nav class="flex overflow-x-auto px-2 pb-0 space-x-2 no-scrollbar bg-slate-900" id="mobile-nav">
            </nav>
    </div>

    <main class="flex-1 overflow-y-auto p-4 md:p-8 relative bg-slate-900 w-full">

            <div id="game-about" class="game-section">
                <div class="bg-slate-800 rounded-2xl p-8 border border-slate-700 shadow-xl text-center">
                    <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400 mb-4">Welcome to Logic Training</h1>
                    <p class="text-slate-300 text-lg mb-8 max-w-2xl mx-auto">This hub is designed to challenge your problem-solving skills. These puzzles require more than just guessing‚Äîthey require <strong>systematic thinking</strong>.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-left">
                        <div class="p-4 bg-slate-900 rounded-xl border border-slate-700">
                            <span class="text-2xl mb-2 block">üß†</span>
                            <h3 class="font-bold text-white">Pure Logic</h3>
                            <p class="text-slate-400 text-sm">No tricks. Every puzzle has a mathematically optimal solution.</p>
                        </div>
                        <div class="p-4 bg-slate-900 rounded-xl border border-slate-700">
                            <span class="text-2xl mb-2 block">üìâ</span>
                            <h3 class="font-bold text-white">Trial & Error</h3>
                            <p class="text-slate-400 text-sm">Mistakes are part of the fun. Learn from them to find the right path.</p>
                        </div>
                        <div class="p-4 bg-slate-900 rounded-xl border border-slate-700">
                            <span class="text-2xl mb-2 block">‚è±Ô∏è</span>
                            <h3 class="font-bold text-white">High Score</h3>
                            <p class="text-slate-400 text-sm">Solving isn't enough. Can you solve it in the minimum number of steps?</p>
                        </div>
                    </div>

                    <button onclick="switchTab('jugs')" class="px-8 py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold text-xl rounded-xl shadow-lg transition transform hover:scale-105">Start Training</button>
                </div>
            </div>

            <div id="game-jugs" class="game-section hidden">
                <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl">
                    <div class="flex justify-between items-start mb-6 border-b border-slate-700 pb-4">
                        <div>
                            <h2 class="text-3xl font-bold text-white">The Water Jug Riddle</h2>
                            <p class="text-slate-300 mt-2 leading-relaxed max-w-2xl">You have three jugs with capacities of 8L, 5L, and 3L. The 8L jug starts completely full. The others are empty. You can pour water from one jug to another until the source is empty OR the destination is full. Measure exactly <strong class="text-blue-400">4 Litres</strong> in one of the jugs.</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="jugInit()" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-bold text-sm">Reset</button>
                            <button onclick="openModal('modal-jugs')" class="px-3 py-1 bg-amber-600 hover:bg-amber-500 text-white rounded font-bold text-sm">Hint</button>
                            <button onclick="openModal('modal-math-jugs')" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded font-bold text-sm">üìñ</button>
                        </div>
                    </div>
                    <div class="flex flex-wrap justify-center items-end gap-12 mb-8 pt-8">
                        <div class="text-center"><div class="text-slate-400 font-bold mb-2">8L Jug</div><div id="jug-0" onclick="jugClick(0)" class="jug-container h-48 w-24 bg-slate-800 border-slate-500 relative hover:border-slate-300"><div id="water-0" class="jug-water h-0"></div><span id="label-0" class="absolute inset-0 flex items-center justify-center font-bold text-white drop-shadow-md z-10">8 / 8L</span></div></div>
                        <div class="text-center"><div class="text-slate-400 font-bold mb-2">5L Jug</div><div id="jug-1" onclick="jugClick(1)" class="jug-container h-36 w-20 bg-slate-800 border-slate-500 relative hover:border-slate-300"><div id="water-1" class="jug-water h-0"></div><span id="label-1" class="absolute inset-0 flex items-center justify-center font-bold text-white drop-shadow-md z-10">0 / 5L</span></div></div>
                        <div class="text-center"><div class="text-slate-400 font-bold mb-2">3L Jug</div><div id="jug-2" onclick="jugClick(2)" class="jug-container h-24 w-16 bg-slate-800 border-slate-500 relative hover:border-slate-300"><div id="water-2" class="jug-water h-0"></div><span id="label-2" class="absolute inset-0 flex items-center justify-center font-bold text-white drop-shadow-md z-10">0 / 3L</span></div></div>
                    </div>
                    <div class="flex justify-center mt-4"><button onclick="jugGiveUp()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 font-bold rounded-xl border border-slate-600">üè≥Ô∏è Give Up</button></div>
                    <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 flex justify-between items-center mt-4"><p id="jug-status" class="text-slate-300 font-mono text-lg">Select a jug to pour from.</p><div class="text-right"><p class="text-xs text-slate-500 uppercase tracking-wide">Moves</p><p id="jug-moves" class="text-2xl font-bold text-indigo-400">0</p></div></div>
                </div>
            </div>

            <div id="game-bulbs" class="game-section hidden">
                <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl">
                    <div class="flex justify-between items-start mb-6 border-b border-slate-700 pb-4">
                        <div>
                            <h2 class="text-3xl font-bold text-white">The Quad-Bulb Riddle</h2>
                            <p class="text-slate-300 mt-2 leading-relaxed max-w-2xl">There are 4 switches outside a closed room. Inside, there are 4 light bulbs. Each switch controls exactly one bulb. You can toggle the switches as much as you want while the door is closed. You can enter the room exactly <strong class="text-red-400">ONCE</strong>. When you enter, you must identify which switch controls which bulb. How can you distinguish them?</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="bulbInit()" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-bold text-sm">Reset</button>
                            <button onclick="openModal('modal-bulbs')" class="px-3 py-1 bg-amber-600 hover:bg-amber-500 text-white rounded font-bold text-sm">Hint</button>
                            <button onclick="openModal('modal-math-bulbs')" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded font-bold text-sm">üìñ</button>
                        </div>
                    </div>
                    <div id="bulb-phase-1" class="mb-8">
                        <div class="bg-slate-900 p-6 rounded-xl border border-slate-700 mb-6">
                            <div class="flex justify-between items-center mb-6"><div class="text-slate-400 font-mono text-sm uppercase">Timer: <span id="bulb-timer" class="text-2xl text-white font-bold ml-2">00m</span></div><button onclick="bulbWait()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-lg border border-slate-500 flex items-center transition transform hover:scale-105"><span>‚è±Ô∏è Wait 10 Minutes</span></button></div>
                            <div class="grid grid-cols-4 gap-8" id="bulb-switches-ui"></div>
                        </div>
                        <div class="flex items-center justify-between mb-4">
                            <p id="bulb-status" class="text-slate-300 font-bold text-sm ml-4">Configure switches before entering.</p>
                            <button onclick="bulbEnterRoom()" class="w-1/2 py-4 bg-red-600 hover:bg-red-500 text-white font-bold text-xl rounded-xl shadow-lg transition">ENTER ROOM (Irreversible)</button>
                        </div>
                        <div class="flex justify-center"><button onclick="bulbGiveUp()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 font-bold rounded-xl border border-slate-600">üè≥Ô∏è Give Up</button></div>
                    </div>
                    <div id="bulb-phase-2" class="hidden">
                        <h3 class="text-2xl font-bold text-emerald-400 mb-4 text-center">üö™ Inside the Room</h3>
                        <div class="grid grid-cols-4 gap-4 mb-8" id="bulb-results"></div>
                        <div class="bg-slate-900 p-6 rounded-xl border border-slate-700"><h4 class="font-bold text-amber-400 mb-4">Connection Report</h4><div class="grid grid-cols-4 gap-2" id="bulb-guesses"></div><button onclick="bulbCheck()" class="w-full mt-6 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl">Verify Connections</button><p id="bulb-final-msg" class="text-center mt-4 font-bold text-lg"></p></div>
                    </div>
                </div>
            </div>

            <div id="game-cat" class="game-section hidden">
                <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl">
                    <div class="flex justify-between items-start mb-6 border-b border-slate-700 pb-4">
                        <div>
                            <h2 class="text-3xl font-bold text-white">The Invincible Cat</h2>
                            <p class="text-slate-300 mt-2 leading-relaxed max-w-2xl">A cat is hiding in one of five boxes that are lined up in a row. The boxes are numbered 1 to 5. Each night the cat hides in an <strong class="text-emerald-400">adjacent box</strong>, exactly one number away. Each morning you can open a single box to try to find the cat. Can you win this game of hide and seek? What is your strategy for finding the cat?</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="catInit()" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-bold text-sm">Reset</button>
                            <button onclick="openModal('modal-cat')" class="px-3 py-1 bg-amber-600 hover:bg-amber-500 text-white rounded font-bold text-sm">Hint</button>
                            <button onclick="openModal('modal-math-cat')" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded font-bold text-sm">üìñ</button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-6 bg-slate-900 p-4 rounded-xl border border-slate-700"><h3 class="text-2xl font-bold text-indigo-400" id="cat-day-display">Day 1</h3><p class="text-xl font-bold text-emerald-400" id="cat-possibilities">5 Spots</p></div>
                    <div class="grid grid-cols-5 gap-4 mb-8" id="cat-boxes"></div>
                    <div class="flex justify-center mb-8"><button id="cat-btn-giveup" onclick="catGiveUp()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 font-bold rounded-xl border border-slate-600">üè≥Ô∏è Give Up & Reveal Path</button></div>
                    <div class="bg-slate-900 rounded-xl border border-slate-700 p-4 h-64 overflow-y-auto" id="cat-logs"></div>
                </div>
            </div>

            <div id="game-river" class="game-section hidden">
                <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl">
                    <div class="flex justify-between items-start mb-6 border-b border-slate-700 pb-4">
                        <div>
                            <h2 class="text-3xl font-bold text-white">The River Crossing Riddle</h2>
                            <p class="text-slate-300 mt-2 leading-relaxed max-w-2xl">5 people must cross a river. The boat holds max 2 people. Crossing times: <strong>1s, 3s, 6s, 8s, 12s</strong>. The boat speed is determined by the slowest person on board. The boat needs a driver to return. Can you get everyone across in <strong class="text-emerald-400">30 seconds or less</strong>?</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="riverInit()" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-bold text-sm">Reset</button>
                            <button onclick="openModal('modal-river')" class="px-3 py-1 bg-amber-600 hover:bg-amber-500 text-white rounded font-bold text-sm">Hint</button>
                            <button onclick="openModal('modal-math-river')" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded font-bold text-sm">üìñ</button>
                        </div>
                    </div>

                    <div id="river-game-area" class="bg-slate-900 p-6 rounded-xl border border-slate-700 mb-6 relative">
                        <div class="river-container relative">
                            <div id="river-bank-left" class="bank left-0"></div>
                            <div id="river-bank-right" class="bank right right-0"></div>
                            <div id="river-boat" class="boat" style="left: 35%;"></div>
                        </div>
                        <div class="flex justify-center mt-6 space-x-4">
                            <button onclick="riverGo()" id="river-btn-go" class="px-8 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold text-xl rounded-xl shadow-lg transition transform hover:scale-105">ROW BOAT</button>
                            <button onclick="riverGiveUp()" id="river-btn-giveup" class="px-6 py-3 bg-slate-600 hover:bg-slate-500 text-white font-bold text-lg rounded-xl">Give Up</button>
                        </div>
                    </div>
                    <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 flex justify-between items-center"><p id="river-status" class="text-slate-300 font-mono text-lg">Load 1 or 2 people onto the boat.</p><div class="text-right"><p class="text-xs text-slate-500 uppercase tracking-wide">Time Elapsed</p><p id="river-time" class="text-3xl font-black text-emerald-400">0s</p></div></div>
                    <div id="river-solution" class="hidden mt-4 bg-slate-900 p-4 rounded-xl border border-amber-500 text-slate-300 text-sm"></div>
                </div>
            </div>

            <div id="game-spider" class="game-section hidden">
                <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl">
                    <div class="flex justify-between items-start mb-6 border-b border-slate-700 pb-4">
                        <div>
                            <h2 class="text-3xl font-bold text-white">The Spider and the Fly</h2>
                            <p class="text-slate-300 mt-2 leading-relaxed max-w-2xl">Help the hungry <strong class="text-blue-400">Blue Spider</strong> catch the <strong class="text-pink-400">Pink Fly</strong>.<br><strong>Rules:</strong> The Spider and Fly take turns moving <strong>1 step</strong> to an adjacent dot.<br>You control the Spider. The Fly tries to escape.<br><strong>Goal:</strong> Catch the Fly in <strong>15 moves</strong> or less.</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="spiderInit()" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-bold text-sm">Reset</button>
                            <button onclick="openModal('modal-spider')" class="px-3 py-1 bg-amber-600 hover:bg-amber-500 text-white rounded font-bold text-sm">Hint</button>
                            <button onclick="openModal('modal-math-spider')" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded font-bold text-sm">üìñ</button>
                        </div>
                    </div>
                    <div class="flex justify-center mb-6 relative">
                        <canvas id="spider-canvas" width="650" height="550"></canvas>
                    </div>
                    <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
                        <p id="spider-status" class="text-slate-300 font-mono text-lg">Your Turn. Click a connected node.</p>
                        <div class="text-right"><p class="text-xs text-slate-500 uppercase tracking-wide">Moves Left</p><p id="spider-moves" class="text-3xl font-black text-indigo-400">15</p></div>
                    </div>
                    <div class="flex justify-center mt-4"><button onclick="spiderGiveUp()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 font-bold rounded-xl border border-slate-600">üè≥Ô∏è Give Up</button></div>
                    <div id="spider-solution" class="hidden mt-4 bg-slate-900 p-4 rounded-xl border border-amber-500 text-slate-300 text-sm text-center"></div>
                </div>
            </div>

            <div id="game-graph" class="game-section hidden">
                <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl">
                    <div class="flex justify-between items-start mb-6 border-b border-slate-700 pb-4">
                        <div>
                            <h2 class="text-3xl font-bold text-white">The Delivery Route</h2>
                            <p class="text-slate-300 mt-2 leading-relaxed max-w-2xl">You are a delivery driver. You must drive through <strong class="text-indigo-400">every single street (line)</strong> exactly once to minimise fuel consumption. You can start at any intersection (dot). Click dots to move. You can <strong class="text-indigo-400">UNDO</strong> your last move by clicking the previous node. If you get stuck, you lose.</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="graphInit()" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-bold text-sm">Reset</button>
                            <button onclick="openModal('modal-graph')" class="px-3 py-1 bg-amber-600 hover:bg-amber-500 text-white rounded font-bold text-sm">Hint</button>
                            <button onclick="openModal('modal-math-graph')" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded font-bold text-sm">üìñ</button>
                        </div>
                    </div>
                    <div class="flex justify-center mb-6 relative">
                        <canvas id="graph-canvas" width="550" height="450"></canvas>
                    </div>
                    <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
                        <p id="graph-status" class="text-slate-300 font-mono text-lg">Click a starting node (Yellow).</p>
                        <div class="text-right"><p class="text-xs text-slate-500 uppercase tracking-wide">Streets Left</p><p id="graph-left" class="text-3xl font-black text-indigo-400">13</p></div>
                    </div>
                    <div class="flex justify-center mt-4">
                        <button onclick="graphGiveUp()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 font-bold rounded-xl border border-slate-600">üè≥Ô∏è Give Up</button>
                    </div>
                    <div id="graph-solution" class="hidden mt-4 bg-slate-900 p-4 rounded-xl border border-amber-500 text-slate-300 text-sm text-center"></div>
                </div>
            </div>

            <div id="game-balls" class="game-section hidden">
                <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl">
                    <div class="flex justify-between items-start mb-6 border-b border-slate-700 pb-4">
                        <div>
                            <h2 class="text-3xl font-bold text-white">The 12 Balls Puzzle</h2>
                            <p class="text-slate-300 mt-2 leading-relaxed max-w-2xl">You have 12 identical-looking balls. One is <strong>counterfeit</strong> (either heavier or lighter). You have a balance scale. You must identify the <strong class="text-emerald-400">specific ball number</strong> AND determine if it is <strong class="text-emerald-400">Heavy or Light</strong> using exactly <strong class="text-red-400">3 weighings</strong>. Guessing is not a strategy.</p>
                        </div>
                        <div class="flex space-x-2"><button onclick="ballsInit()" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-bold text-sm">Reset</button><button onclick="openModal('modal-balls')" class="px-3 py-1 bg-amber-600 hover:bg-amber-500 text-white rounded font-bold text-sm">Hint</button><button onclick="openModal('modal-math-balls')" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded font-bold text-sm">üìñ</button></div>
                    </div>
                    <div class="bg-slate-900/50 rounded-xl p-6 mb-6 relative">
                        <div class="flex justify-center space-x-8 mb-4"><div class="w-1/2"><p class="text-center text-xs text-slate-500 font-bold mb-1">LEFT (<span id="balls-left-count">0</span>)</p><div id="balls-pan-left" class="pan"></div></div><div class="w-1/2"><p class="text-center text-xs text-slate-500 font-bold mb-1">RIGHT (<span id="balls-right-count">0</span>)</p><div id="balls-pan-right" class="pan"></div></div></div>
                        <div id="balls-result-box" class="scale-result bg-slate-700 text-center p-3 rounded-lg font-bold text-slate-200 mb-4 border border-slate-600"></div>
                        <div class="flex justify-center space-x-4"><button id="balls-btn-weigh" onclick="ballsWeigh()" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl transition shadow-lg">WEIGH</button><button onclick="ballsGiveUp()" class="px-6 py-3 bg-slate-600 hover:bg-slate-500 text-white font-bold rounded-xl">Give Up</button></div>
                        <p id="balls-weighs-left" class="absolute top-4 right-4 text-xl font-bold text-indigo-400">Left: 3</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><div id="balls-pool" class="flex flex-wrap gap-3 p-4 bg-slate-900 rounded-xl min-h-[100px]"></div><div class="mt-6 p-4 bg-emerald-900/20 border border-emerald-700/50 rounded-xl"><div class="flex space-x-2 mb-2"><select id="balls-guess-id" class="bg-slate-900 border border-slate-600 rounded p-2 text-white w-full"></select><select id="balls-guess-status" class="bg-slate-900 border border-slate-600 rounded p-2 text-white w-full"><option value="">Status</option><option value="Heavy">Heavy</option><option value="Light">Light</option></select></div><button onclick="ballsCheck()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg transition">Identify</button></div></div>
                        <div class="bg-slate-900 rounded-xl p-4 border border-slate-700 h-80 overflow-y-auto" id="balls-logs"></div>
                    </div>
                </div>
            </div>

            <div id="game-horses" class="game-section hidden">
                <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl">
                    <div class="flex justify-between items-start mb-6 border-b border-slate-700 pb-4">
                        <div>
                            <h2 class="text-3xl font-bold text-white">The 25 Horses Puzzle</h2>
                            <p class="text-slate-300 mt-2 leading-relaxed max-w-2xl">There are 25 horses. You need to identify the fastest, second fastest, and third fastest horses. You have a race track that can race up to 5 horses at a time. There is <strong class="text-red-400">NO timer or stopwatch</strong>; you only see the relative finishing order of each race (1st, 2nd, 3rd...). What is the minimum number of races required to identify the Top 3 with certainty?</p>
                        </div>
                        <div class="flex space-x-2"><button onclick="horseInit()" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-bold text-sm">Reset</button><button onclick="openModal('modal-horses')" class="px-3 py-1 bg-amber-600 hover:bg-amber-500 text-white rounded font-bold text-sm">Hint</button><button onclick="openModal('modal-math-horses')" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded font-bold text-sm">üìñ</button></div>
                    </div>
                    <div class="flex flex-col lg:flex-row gap-6">
                        <div class="lg:w-1/2 space-y-6">
                            <div class="bg-slate-900/50 rounded-xl p-4 border border-slate-700 relative">
                                <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-pink-400 uppercase tracking-wider text-sm">Race Track (Click horses to add)</h3><span id="horse-race-count" class="text-lg font-bold text-white bg-pink-600 px-3 py-1 rounded-lg">Races: 0</span></div>
                                <div id="horse-track" class="flex justify-center space-x-4 mb-6 p-4 bg-slate-800 rounded-xl min-h-[80px]"></div>
                                <button onclick="horseRace()" id="horse-btn-race" class="w-full py-3 bg-pink-600 hover:bg-pink-500 text-white font-bold text-xl rounded-xl shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed">RACE!</button>
                            </div>
                            <div class="bg-slate-900 rounded-xl p-4 border border-slate-700"><h3 class="font-bold text-slate-400 mb-2 text-sm">Stable</h3><div id="horse-pool" class="flex flex-wrap gap-2 p-4 bg-slate-900 rounded-xl min-h-[150px]"></div></div>
                        </div>
                        <div class="lg:w-1/2 space-y-6">
                            <div class="bg-slate-900 rounded-xl p-4 border border-slate-700"><h3 class="font-bold text-indigo-400 mb-2 text-sm uppercase tracking-wide">Strategy Board (Drag to Sort, Click to Return)</h3><div class="grid grid-cols-6 gap-1 mb-2 text-xs text-slate-500 text-center font-mono"><div>GRP</div><div>1st</div><div>2nd</div><div>3rd</div><div>4th</div><div>5th</div></div><div id="horse-grid" class="space-y-1"></div></div>
                            <div class="bg-slate-900 rounded-xl p-4 border border-slate-700 h-48 overflow-y-auto">
                                <div class="flex justify-between items-center mb-2 sticky top-0 bg-slate-900 pb-1 border-b border-slate-700">
                                    <h3 class="font-bold text-slate-300 text-sm">Race Logs</h3>
                                    <span id="horse-status" class="text-xs font-bold text-slate-500">Ready</span>
                                </div>
                                <div id="horse-logs" class="space-y-2 text-sm"></div>
                            </div>
                            <div class="p-4 bg-indigo-900/30 border border-indigo-700 rounded-xl">
                                <div class="flex space-x-2 mb-2"><input type="number" id="h-pred-1" placeholder="#1" class="bg-slate-900 border border-slate-600 rounded p-2 w-full text-white text-center"><input type="number" id="h-pred-2" placeholder="#2" class="bg-slate-900 border border-slate-600 rounded p-2 w-full text-white text-center"><input type="number" id="h-pred-3" placeholder="#3" class="bg-slate-900 border border-slate-600 rounded p-2 w-full text-white text-center"></div>
                                <button onclick="horseCheck()" class="w-full py-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg mb-2">Submit Top 3</button>
                                <button onclick="horseGiveUp()" class="w-full py-2 bg-slate-600 hover:bg-slate-500 text-white font-bold rounded-lg">Give Up</button>
                                <p id="horse-final-msg" class="text-center mt-2 font-bold text-sm"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>
    
    <footer class="bg-slate-900 border-t border-slate-700 py-4 text-center mt-auto">
        <p class="text-slate-500 text-sm italic">"Together Sharpening our Minds"</p>
    </footer>

    <div id="modal-login" class="modal" onclick="closeModal('modal-login')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold text-white mb-4">Login</h3>
            <input type="text" id="login-id" placeholder="Enter Username" class="w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-white mb-4">
            <button onclick="handleLogin()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg">Login</button>
            <button onclick="handleLogout()" class="w-full py-2 mt-2 bg-slate-700 hover:bg-slate-600 text-slate-400 font-bold rounded-lg">Logout / Guest Mode</button>
        </div>
    </div>

    <div id="modal-jugs" class="modal" onclick="closeModal('modal-jugs')"><div class="modal-content"><h3 class="text-xl font-bold text-amber-500 mb-2">Hint: 3 Jugs</h3><p class="text-slate-300">Focus on the difference between the jug capacities. How can you derive 1 Litre first?</p><button onclick="closeModal('modal-jugs')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button></div></div>
    <div id="modal-bulbs" class="modal" onclick="closeModal('modal-bulbs')"><div class="modal-content"><h3 class="text-xl font-bold text-amber-500 mb-2">Hint: Quad-Bulb</h3><p class="text-slate-300">You need to identify 4 specific bulbs, but you only have 2 visual states (ON/OFF). What physical property changes over time?</p><button onclick="closeModal('modal-bulbs')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button></div></div>
    <div id="modal-cat" class="modal" onclick="closeModal('modal-cat')"><div class="modal-content"><h3 class="text-xl font-bold text-amber-500 mb-2">Hint: Quantum Cat</h3><p class="text-slate-300">The cat alternates between Odd and Even boxes every night. How can you use this 'Parity' to trap it?</p><button onclick="closeModal('modal-cat')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button></div></div>
    <div id="modal-balls" class="modal" onclick="closeModal('modal-balls')"><div class="modal-content"><h3 class="text-xl font-bold text-amber-500 mb-2">Hint: 12 Balls</h3><p class="text-slate-300">A balance scale gives you 3 outcomes (Left, Right, Balanced). To solve this in 3 weighings, you must maximise the information gained in step 1. What group size allows you to narrow down the suspects most efficiently?</p><button onclick="closeModal('modal-balls')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button></div></div>
    <div id="modal-horses" class="modal" onclick="closeModal('modal-horses')"><div class="modal-content"><h3 class="text-xl font-bold text-amber-500 mb-2">Hint: 25 Horses</h3><p class="text-slate-300">You have no stopwatch, only relative order. If Horse A beats B, and B beats C, then A > C. Use this transitive property to eliminate any horse that cannot mathematically be in the Top 3.</p><button onclick="closeModal('modal-horses')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button></div></div>
    <div id="modal-river" class="modal" onclick="closeModal('modal-river')"><div class="modal-content"><h3 class="text-xl font-bold text-amber-500 mb-2">Hint: River Crossing</h3><p class="text-slate-300">Don't let the fastest person do all the work. Think about how to move the two slowest people across together to save time.</p><button onclick="closeModal('modal-river')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button></div></div>
    <div id="modal-graph" class="modal" onclick="closeModal('modal-graph')"><div class="modal-content"><h3 class="text-xl font-bold text-amber-500 mb-2">Hint: Delivery</h3><p class="text-slate-300">Count the lines connected to each dot. Does every dot have an even number of lines?</p><button onclick="closeModal('modal-graph')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button></div></div>
    <div id="modal-spider" class="modal" onclick="closeModal('modal-spider')"><div class="modal-content"><h3 class="text-xl font-bold text-amber-500 mb-2">Hint: The Spider</h3><p class="text-slate-300">Think about how to trap a target in a grid. Reduce their available moves by occupying key intersections.</p><button onclick="closeModal('modal-spider')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button></div></div>

    <div id="modal-math-jugs" class="modal" onclick="closeModal('modal-math-jugs')">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-indigo-400 mb-2">The Logic Principle: Diophantine Equations</h3>
            <p class="text-slate-300 text-sm">This puzzle is a visual representation of the linear Diophantine equation: <strong>Ax + By = C</strong>. <br><br>Here, <strong>5x + 3y = 4</strong>. Since 5 and 3 are coprime (their greatest common divisor is 1), any integer amount can be measured. We solve for integer steps of pouring (x) and emptying (y) to reach the remainder 4.</p>
            <button onclick="closeModal('modal-math-jugs')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button>
        </div>
    </div>
    <div id="modal-math-cat" class="modal" onclick="closeModal('modal-math-cat')">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-indigo-400 mb-2">The Logic Principle: Parity Arguments</h3>
            <p class="text-slate-300 text-sm">The boxes form a <strong>Bipartite Graph</strong>. The cat moves between two disjoint sets (Odd numbers and Even numbers) at each step. By checking boxes in a specific sequence (2,3,4...), we force the cat into a subset where its position contradicts its parity (it must be Even when we check Odd), eventually leaving it no valid node to occupy.</p>
            <button onclick="closeModal('modal-math-cat')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button>
        </div>
    </div>
    <div id="modal-math-graph" class="modal" onclick="closeModal('modal-math-graph')">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-indigo-400 mb-2">The Logic Principle: Eulerian Paths</h3>
            <p class="text-slate-300 text-sm">A graph can be traversed in a single continuous line (Eulerian Path) if and only if it has <strong>exactly zero or two nodes of odd degree</strong>. <br><br>If it has zero odd nodes, you can start anywhere. If it has two, you <strong>must</strong> start at one odd node and will inevitably end at the other. This graph has two odd nodes (Degree 3). Starting anywhere else makes the solution mathematically impossible.</p>
            <button onclick="closeModal('modal-math-graph')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button>
        </div>
    </div>
    <div id="modal-math-balls" class="modal" onclick="closeModal('modal-math-balls')">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-indigo-400 mb-2">The Logic Principle: Information Theory</h3>
            <p class="text-slate-300 text-sm">Each weighing has 3 possible outcomes: Left Heavy, Right Heavy, or Balanced. This is a <strong>Ternary Search</strong> tree. <br><br>With 3 weighings, the maximum distinct outcomes are 3^3 = 27. We have 12 balls, each could be Heavy or Light (24 possibilities). Since 24 < 27, it is theoretically solvable. An "Adaptive Strategy" is required where each step divides the remaining possibility space by 3.</p>
            <button onclick="closeModal('modal-math-balls')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button>
        </div>
    </div>
    <div id="modal-math-horses" class="modal" onclick="closeModal('modal-math-horses')">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-indigo-400 mb-2">The Logic Principle: Sorting Complexity</h3>
            <p class="text-slate-300 text-sm">This is a problem of finding the top <em>k</em> elements in an unsorted set with limited comparison capacity (5 items max). It relates to <strong>Parallel Sorting Algorithms</strong>. <br><br>By racing groups, we create a partial ordering (a Directed Acyclic Graph). We then use transitivity (If A>B and B>C, then A>C) to "prune" branches of the tree that cannot possibly contain the top 3 candidates, reducing the search space dramatically.</p>
            <button onclick="closeModal('modal-math-horses')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button>
        </div>
    </div>
    <div id="modal-math-river" class="modal" onclick="closeModal('modal-math-river')">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-indigo-400 mb-2">The Logic Principle: Critical Path Analysis</h3>
            <p class="text-slate-300 text-sm">This is a classic <strong>Scheduling Problem</strong>. We want to minimize the total cost (time) of a series of dependent tasks. <br><br>The cost is determined by the maximum value in any "batch" (boat load). The optimal strategy exploits this max function by grouping the two largest values (8 and 12) into a single trip, effectively "hiding" the smaller cost inside the larger one.</p>
            <button onclick="closeModal('modal-math-river')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button>
        </div>
    </div>
    <div id="modal-math-spider" class="modal" onclick="closeModal('modal-math-spider')">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-indigo-400 mb-2">The Logic Principle: Pursuit-Evasion Games</h3>
            <p class="text-slate-300 text-sm">This is a discrete game on a graph. The "Hunter" wins by reducing the "Prey's" available territory. <br><br>The graph has a central node with high <strong>Betweenness Centrality</strong> (Node O). By occupying this node, the Hunter minimizes the Maximum Distance to any other node, effectively partitioning the graph and trapping the Prey in a smaller subgraph.</p>
            <button onclick="closeModal('modal-math-spider')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button>
        </div>
    </div>
    <div id="modal-math-bulbs" class="modal" onclick="closeModal('modal-math-bulbs')">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-indigo-400 mb-2">The Logic Principle: Lateral Variables</h3>
            <p class="text-slate-300 text-sm">Standard binary logic (1/0) offers 2 bits of information (ON/OFF). This is insufficient to identify 4 distinct items (requires 2 bits -> 4 states). <br><br>We solve this by introducing a new dimension: <strong>State Decay</strong> (Thermodynamics). By letting a bulb heat up and then turning it off, we create a "third state" (OFF but HOT), and a "fourth state" (OFF but WARM), successfully mapping 4 unique identifiers.</p>
            <button onclick="closeModal('modal-math-bulbs')" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Close</button>
        </div>
    </div>

    <script>
        // --- SYSTEM: UTILS & DATA ---
        let currentUser = localStorage.getItem('logic_user') || null;
        const apiUrl = "https://script.google.com/macros/s/AKfycbxlaaj_TLDH0LyWWm1BAVQ9vdlL8fPo1AvBQu3a707Z2WNnZnkdaMKJPzZk5VwN6rQ/exec";
        let timerInterval = null;
        let startTime = 0;
        let timerVisible = false; 

        // Sound System
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq = 440, type = 'sine', duration = 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // Modal Utilities
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        // Status Update Utility
        function updateStatus(elementId, msg, isError = false) {
            const el = document.getElementById(elementId);
            el.innerText = msg;
            if(isError) {
                el.classList.add('status-error');
                setTimeout(() => el.classList.remove('status-error'), 1000);
            }
        }

        // Auth Logic
        function updateAuthUI() {
            const dBtn = document.getElementById('user-status-desktop');
            const mBtn = document.getElementById('user-status-mobile');
            const txt = currentUser ? currentUser : 'Login';
            if(dBtn) dBtn.innerText = txt;
            if(mBtn) mBtn.innerText = currentUser ? 'üë§' : 'üë§';
        }

        function handleLogin() {
            const input = document.getElementById('login-id').value;
            if(input) {
                currentUser = input;
                localStorage.setItem('logic_user', currentUser);
                updateAuthUI();
                closeModal('modal-login');
                playSound(600, 'sine');
            }
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('logic_user');
            updateAuthUI();
            closeModal('modal-login');
        }

       // Data Logic
        function sendData(game, result, details, optimal) {
            // Calculate duration based on the global startTime
            // We use the global 'startTime' variable set by startTimer()
            const currentDuration = Math.floor((Date.now() - startTime) / 1000);

            console.log(`Sending: ${game} | ${result} | Metric: ${details} | Time: ${currentDuration}s`);
            
            const payload = {
                user: currentUser || "Guest",
                game: game,       // This maps to Puzzle_Name
                result: result,   // This maps to Result
                details: details, // This maps to Metric
                optimal: optimal, // This maps to Is_Optimal
                duration: currentDuration // This maps to Duration_Sec
            };

            fetch(apiUrl, {
                method: "POST",
                mode: "no-cors", // Important for Google Scripts
                headers: {
                    "Content-Type": "text/plain;charset=utf-8"
                },
                body: JSON.stringify(payload)
            }).then(() => {
                console.log("Data sent to Sheet.");
            }).catch(err => {
                console.error("Failed to send data:", err);
            });
        }
        }
        // --- PROGRESSION SYSTEM ---
        const puzzleNames = {
            'jugs': '3 Jugs', 'bulbs': '4 Switches', 'cat': '5 Boxes', 'river': '5 People',
            'spider': 'Spider', 'graph': '13 Streets', 'balls': '12 Balls', 'horses': '25 Horses'
        };

        function renderSidebar() {
            const dNav = document.getElementById('desktop-nav');
            const mNav = document.getElementById('mobile-nav');
            if(!dNav || !mNav) return;
            
            const progress = JSON.parse(localStorage.getItem('logic_progress') || '{}');
            const items = ['jugs', 'bulbs', 'cat', 'river', 'spider', 'graph', 'balls', 'horses'];
            
            dNav.innerHTML = ''; mNav.innerHTML = '';
            
            items.forEach(id => {
                const name = puzzleNames[id];
                const p = progress[id] || {};
                let icon = '';
                if(p.optimal) icon = 'üåü';
                else if(p.complete) icon = '‚úÖ';
                
                // Desktop
                const btn = document.createElement('div');
                btn.id = `nav-${id}`; btn.className = 'nav-item';
                btn.onclick = () => switchTab(id);
                btn.innerHTML = `<span>${name}</span><span class="nav-icon">${icon}</span>`;
                dNav.appendChild(btn);
                
                // Mobile
                const mBtn = document.createElement('button');
                mBtn.id = `mob-${id}`; mBtn.className = 'mobile-tab';
                mBtn.onclick = () => switchTab(id);
                mBtn.innerHTML = `${name} ${icon}`;
                mNav.appendChild(mBtn);
            });
        }

        function markComplete(id, isOptimal) {
            let progress = JSON.parse(localStorage.getItem('logic_progress') || '{}');
            const current = progress[id] || { complete: false, optimal: false };
            
            if (!current.complete) {
                progress[id] = { complete: true, optimal: isOptimal };
            } else if (isOptimal && !current.optimal) {
                progress[id] = { complete: true, optimal: true };
            }
            localStorage.setItem('logic_progress', JSON.stringify(progress));
            renderSidebar();
        }

        // --- SMART TIMER & TABS ---
        function switchTab(id) {
            document.querySelectorAll('.game-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(`game-${id}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            const dNav = document.getElementById(`nav-${id}`);
            if(dNav) dNav.classList.add('active');

            document.querySelectorAll('.mobile-tab').forEach(e => e.classList.remove('active'));
            const mNav = document.getElementById(`mob-${id}`);
            if(mNav) mNav.classList.add('active');

            if (id !== 'about') startTimer();
        }

        function startTimer() { 
            startTime = Date.now(); 
            if(timerInterval) clearInterval(timerInterval); 
            timerInterval = setInterval(updateTimerDisplay, 1000); 
            updateTimerDisplay(); 
        }
        
        function updateTimerDisplay() {
            const now = Date.now();
            const diff = Math.floor((now - startTime) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            const dTimer = document.getElementById('global-timer-desktop');
            if(dTimer) dTimer.innerText = timerVisible ? `${m}:${s}` : "‚è±Ô∏è Time";
            const mTimer = document.getElementById('global-timer-mobile');
            if(mTimer) mTimer.innerText = timerVisible ? `${m}:${s}` : "‚è±Ô∏è";
        }
        
        function toggleTimer() { timerVisible = !timerVisible; updateTimerDisplay(); }

        // --- GAME LOGIC STARTS HERE ---
		/* --- GAME 1: 3 JUGS --- */
        let jugState = { jugs:[8,0,0], caps:[8,5,3], selected:null, solved:false, moves:0 };
        function jugInit(){ jugState.jugs=[8,0,0]; jugState.selected=null; jugState.solved=false; jugState.moves=0; document.getElementById('jug-status').innerText="Select a jug to pour from."; document.getElementById('jug-status').className="text-slate-300 font-mono text-lg"; document.getElementById('jug-moves').innerText="0"; jugRender(); }
        function jugClick(idx){ if(jugState.solved)return; if(jugState.selected===null){ if(jugState.jugs[idx]>0){ jugState.selected=idx; document.getElementById('jug-status').innerText=`Selected Jug ${jugState.caps[idx]}L. Click another to pour.`; } else updateStatus('jug-status', "Cannot select empty jug.", true); } else { if(jugState.selected===idx){ jugState.selected=null; document.getElementById('jug-status').innerText="Deselected."; } else { jugPour(jugState.selected, idx); jugState.selected=null; } } jugRender(); }
        function jugPour(f,t){ const amt=Math.min(jugState.jugs[f], jugState.caps[t]-jugState.jugs[t]); if(amt>0){ jugState.jugs[f]-=amt; jugState.jugs[t]+=amt; jugState.moves++; document.getElementById('jug-moves').innerText=jugState.moves; playSound(400,'sine'); document.getElementById('jug-status').innerText=`Poured ${amt}L.`; jugCheck(); } else updateStatus('jug-status', "Cannot pour (Source empty or Dest full).", true); }
        function jugRender(){ jugState.jugs.forEach((v,i)=>{ const el=document.getElementById(`water-${i}`); el.style.height=`${(v/jugState.caps[i])*100}%`; document.getElementById(`label-${i}`).innerText=`${v} / ${jugState.caps[i]}L`; const c=document.getElementById(`jug-${i}`); if(jugState.selected===i)c.classList.add('jug-selected'); else c.classList.remove('jug-selected'); }); }
        function jugCheck(){ if(jugState.jugs.includes(4)){ jugState.solved=true; const msg=jugState.moves===6?"PERFECT! 6 Moves (Optimised).":`SUCCESS! Solved in ${jugState.moves} moves.`; document.getElementById('jug-status').innerText=msg; document.getElementById('jug-status').className="text-emerald-400 font-bold text-xl animate-bounce"; playSound(600); const isOptimal = (jugState.moves === 6); sendData('3 Jugs', 'Win', jugState.moves, isOptimal); markComplete('jugs', isOptimal); } }
        function jugGiveUp(){ 
            // Immediate Reset
            jugInit(); 
            updateStatus('jug-status', "GAVE UP. Game Reset. Hint: 5L - 3L = 2L."); 
            sendData('3 Jugs', 'GiveUp', '-', false); 
        }

        /* --- GAME 2: BULBS (Hidden Info -> 4s Delay) --- */
        let bulbState={map:{},switches:{},over:false,entered:false,time:0};
        const bulbNames=['A','B','C','D'];
        function bulbInit(){
            bulbState.map={1:null,2:null,3:null,4:null};
            let s=['A','B','C','D'].sort(()=>Math.random()-0.5);
            [1,2,3,4].forEach((n,i)=>bulbState.map[n]=s[i]);
            bulbState.switches={A:{on:false,heat:0},B:{on:false,heat:0},C:{on:false,heat:0},D:{on:false,heat:0}};
            bulbState.over=false;bulbState.entered=false;bulbState.time=0;
            document.getElementById('bulb-phase-1').classList.remove('hidden');
            document.getElementById('bulb-phase-2').classList.add('hidden');
            document.getElementById('bulb-final-msg').innerText="";
            document.getElementById('bulb-timer').innerText="00m";
            updateStatus('bulb-status', "Configure switches before entering.");
            bulbRenderSwitches();
        }
        function bulbToggle(id){if(bulbState.over)return; const s=bulbState.switches[id];s.on=!s.on;bulbRenderSwitches();playSound(300,'square')}
        function bulbWait(){
            if(bulbState.over)return;
            bulbState.time+=10;document.getElementById('bulb-timer').innerText=bulbState.time+"m";
            bulbNames.forEach(id=>{if(bulbState.switches[id].on)bulbState.switches[id].heat+=10});
            playSound(200,'sine');
            const el=document.getElementById('bulb-switches-ui');
            el.style.opacity=0.5;setTimeout(()=>el.style.opacity=1,200)
        }
        function bulbRenderSwitches(){const c=document.getElementById('bulb-switches-ui');c.innerHTML='';bulbNames.forEach(id=>{const s=bulbState.switches[id];const bg=s.on?"bg-emerald-900/50 border-emerald-500":"bg-slate-900 border-slate-700";const txt=s.on?"text-emerald-400":"text-slate-500";c.innerHTML+=`<div class="${bg} p-4 rounded-xl border flex flex-col items-center transition-colors duration-200"><span class="text-3xl font-bold text-slate-300 mb-2">${id}</span><button onclick="bulbToggle('${id}')" class="w-full py-2 rounded-lg font-bold text-white ${s.on?'bg-emerald-600':'bg-slate-600'}">${s.on?'ON':'OFF'}</button></div>`})}
        function bulbEnterRoom(){
            bulbState.entered=true;
            document.getElementById('bulb-phase-1').classList.add('hidden');
            document.getElementById('bulb-phase-2').classList.remove('hidden');
            const r=document.getElementById('bulb-results');const g=document.getElementById('bulb-guesses');
            r.innerHTML='';g.innerHTML='';
            [1,2,3,4].forEach(n=>{
                const sid=bulbState.map[n];const s=bulbState.switches[sid];
                let cls="bulb-off",txt="OFF",tCls="heat-low",tTxt="COLD";
                if(s.on){cls="bulb-on";txt="ON"}
                if(s.heat>=15){tCls="heat-high";tTxt="HOT"}else if(s.heat>0){tCls="heat-med";tTxt="WARM"}
                r.innerHTML+=`<div class="bg-slate-800 p-4 rounded-xl border border-slate-600 flex flex-col items-center ${cls} ${tCls} transition-all"><span class="text-xl font-bold mb-2">Bulb ${n}</span><span class="text-2xl font-black mb-1">${txt}</span><span class="text-xs font-bold opacity-75">${tTxt}</span></div>`;
                g.innerHTML+=`<div class="flex items-center justify-between bg-slate-800 p-2 rounded border border-slate-600"><span class="font-bold text-slate-400 mr-2">B${n}:</span><select id="bulb-guess-${n}" class="bg-slate-900 text-white p-1 rounded w-full"><option value="">?</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select></div>`
            })
        }
        function bulbCheck(){let c=0;[1,2,3,4].forEach(n=>{if(document.getElementById(`bulb-guess-${n}`).value===bulbState.map[n])c++});const m=document.getElementById('bulb-final-msg');if(c===4){m.className="text-emerald-400 mt-4 text-center font-bold text-xl";m.innerText="VICTORY!";sendData('4 Switches', 'Win', '-', true); markComplete('bulbs', true);}else{m.className="text-rose-400 mt-4 text-center font-bold";m.innerText=`Incorrect. ${c}/4 right.`;sendData('4 Switches', 'Fail', c+'/4', false);}}
        function bulbGiveUp(){ 
            if(!bulbState.entered) bulbEnterRoom(); 
            const m = document.getElementById('bulb-final-msg'); 
            // Show Answer
            let ans = ""; [1,2,3,4].forEach(n => ans += `B${n}=${bulbState.map[n]} `);
            m.innerText = `Answers: ${ans}`; 
            m.className = "text-amber-400 font-mono text-center mt-4 font-bold text-sm"; 
            sendData('4 Switches', 'GiveUp', '-', false); 
            setTimeout(() => { bulbInit(); }, 4000);
        }

        /* --- GAME 3: CAT (Hidden Info -> 4s Delay) --- */
        const catState={day:1,pos:new Set([1,2,3,4,5]),history:[],over:false};
        function catInit(){catState.day=1;catState.pos=new Set([1,2,3,4,5]);catState.history=[new Set([1,2,3,4,5])];catState.over=false;document.getElementById('cat-logs').innerHTML='';catRender();}
        function catRender(){document.getElementById('cat-day-display').innerText=`Day ${catState.day}`;document.getElementById('cat-possibilities').innerText=`${catState.pos.size} Spots`;const c=document.getElementById('cat-boxes');c.innerHTML='';for(let i=1;i<=5;i++){const b=document.createElement('button');b.className=`box-btn h-24 bg-slate-800 rounded-xl border-2 border-slate-600 flex items-center justify-center text-3xl font-black text-slate-600 group hover:border-indigo-500 hover:text-indigo-400 quantum-active`;b.innerText=i;b.onclick=()=>catCheck(i);if(catState.over)b.disabled=true;c.appendChild(b)}}
        function catCheck(id){
            if(catState.over)return;
            let caught=false;
            if(catState.pos.has(id)){ if(catState.pos.size===1)caught=true;else catState.pos.delete(id) }
            const l=document.getElementById('cat-logs');const e=document.createElement('div');
            e.className=`p-3 mb-2 border-l-4 rounded bg-slate-800 ${caught?'border-emerald-500':'border-rose-500'}`;
            e.innerHTML=`<div class="flex justify-between text-sm text-slate-300"><span>Day ${catState.day}</span><span class="${caught?'text-emerald-400':'text-rose-400'} font-bold">${caught?'CAUGHT':'MISSED'}</span></div><div class="text-xs text-slate-500">Checked Box ${id}.</div>`;
            l.prepend(e);
            if(caught){
                catState.over=true;document.getElementById('cat-boxes').children[id-1].classList.add('bg-emerald-900','border-emerald-500','text-emerald-400');
                playSound(600);catRevealPath(id);
                const isOptimal = (catState.day <= 6); sendData('5 Boxes', 'Win', `Day ${catState.day}`, isOptimal); markComplete('cat', isOptimal);
            }else{
                playSound(150,'sawtooth');
                const next=new Set();
                catState.pos.forEach(p=>{if(p>1)next.add(p-1);if(p<5)next.add(p+1)});
                catState.pos=next;catState.history.push(new Set(next));
                catState.day++;catRender()
            }
        }
        function catRevealPath(end){let p=[end],c=end;for(let d=catState.history.length-2;d>=0;d--){const prev=catState.history[d];const cands=[];if(prev.has(c-1))cands.push(c-1);if(prev.has(c+1))cands.push(c+1);c=cands[Math.floor(Math.random()*cands.length)];p.unshift(c)}const d=document.createElement('div');d.className="mt-4 p-3 bg-slate-700 rounded border border-slate-600";d.innerHTML=`<div class="text-xs text-indigo-300 font-bold uppercase mb-2">Quantum Path</div><div class="flex flex-wrap gap-2 text-sm font-mono text-white">${p.join(' ‚Üí ')}</div>`;document.getElementById('cat-logs').prepend(d)}
        function catGiveUp(){ 
            if(catState.over)return; catState.over=true;
            const arr=Array.from(catState.pos);const final=arr.length?arr[Math.floor(Math.random()*arr.length)]:1;
            catRevealPath(final);
            document.getElementById('cat-boxes').children[final-1].classList.add('bg-amber-900','border-amber-500','text-amber-400'); 
            const l=document.getElementById('cat-logs'); 
            const e=document.createElement('div'); e.className="mt-4 p-3 bg-slate-700 rounded border border-slate-600 font-bold text-amber-400"; 
            e.innerText="GAVE UP. Showing Answer..."; 
            l.prepend(e); 
            sendData('5 Boxes', 'GiveUp', `Day ${catState.day}`, false); 
            setTimeout(() => { catInit(); }, 4000);
        }

        /* --- GAME 4: RIVER (Immediate Reset) --- */
        let riverState = { left:[1,3,6,8,12], right:[], boat:[], side:'left', time:0, solved:false, fail:false };
        function riverInit(){ riverState = { left:[1,3,6,8,12], right:[], boat:[], side:'left', time:0, solved:false, fail:false }; document.getElementById('river-time').innerText = "0s"; document.getElementById('river-status').innerText = "Load 1 or 2 people onto the boat."; document.getElementById('river-status').className = "text-slate-300 font-mono text-lg"; document.getElementById('river-game-area').classList.remove('shake-fail'); document.getElementById('river-solution').classList.add('hidden'); riverRender(); }
        function riverClick(val, loc) { 
            if(riverState.solved || riverState.fail) return; 
            if(loc === 'boat') { 
                const idx = riverState.boat.indexOf(val); 
                if(idx>-1) { riverState.boat.splice(idx,1); riverState[riverState.side].push(val); playSound(200); } 
            } else { 
                if(loc !== riverState.side) return updateStatus('river-status', "Boat is on the other side!", true); 
                if(riverState.boat.length >= 2) return updateStatus('river-status', "Boat is full!", true);
                const idx = riverState[loc].indexOf(val); 
                if(idx>-1) { riverState[loc].splice(idx,1); riverState.boat.push(val); playSound(200); } 
            } 
            riverRender(); 
            riverCheck(); 
        }
        function riverGo(){ 
            if(riverState.solved || riverState.fail) return; 
            if(riverState.boat.length === 0) return updateStatus('river-status', "Boat is empty!", true);
            const tripTime = Math.max(...riverState.boat); 
            riverState.time += tripTime; 
            riverState.side = riverState.side === 'left' ? 'right' : 'left'; 
            document.getElementById('river-time').innerText = riverState.time + "s"; 
            if(riverState.time > 30) { 
                riverState.fail = true; 
                document.getElementById('river-status').innerText = "GAME OVER! Too Slow (>30s). Resetting..."; 
                document.getElementById('river-status').className = "text-rose-500 font-bold text-xl"; 
                document.getElementById('river-game-area').classList.add('shake-fail'); 
                playSound(100, 'sawtooth'); 
                sendData('River', 'Fail', riverState.time, false); 
                setTimeout(riverInit, 2500); 
            } else { 
                playSound(100,'triangle'); 
                riverCheck(); 
            } 
            riverRender(); 
        }
        function riverRender(){ const l=document.getElementById('river-bank-left'); const r=document.getElementById('river-bank-right'); const b=document.getElementById('river-boat'); const draw = (arr, el, loc) => { el.innerHTML = arr.sort((a,b)=>a-b).map(p => `<div onclick="riverClick(${p}, '${loc}')" class="person"><span class="text-2xl">üë§</span><span class="person-time">${p}s</span></div>`).join(''); }; draw(riverState.left, l, 'left'); draw(riverState.right, r, 'right'); draw(riverState.boat, b, 'boat'); b.style.left = riverState.side === 'left' ? '35%' : 'calc(100% - 35% - 140px)'; }
        function riverCheck(){ 
            // WIN CONDITION: Left side is empty.
            if(riverState.left.length === 0) { 
                if(riverState.time <= 30) { 
                    riverState.solved = true; 
                    // Optimal is 26s as requested
                    const isOptimal = (riverState.time <= 26); 
                    const msg = document.getElementById('river-status'); 
                    msg.innerText = `VICTORY! Solved in ${riverState.time}s (Optimal is 26s).`; 
                    msg.className = "text-emerald-400 font-bold text-xl animate-bounce"; 
                    playSound(600); 
                    sendData('River', 'Win', riverState.time, isOptimal); 
                    markComplete('river', isOptimal); 
                } 
            } 
        }
        function riverGiveUp() { 
            // Immediate Reset
            riverInit(); 
            updateStatus('river-status', "GAVE UP. Game Reset."); 
            sendData('River', 'GiveUp', '-', false); 
        }

        /* --- GAME 5: SPIDER (Fitted Cone Layout) --- */
        let spiderState = { player: 12, spider: 4, moves: 15, over: false }; 
        
        function getSpiderNeighbors(id) {
            const n = [];
            if (id === 0) { return [1, 5, 9, 13, 17]; } 
            const val = id - 1;
            const ray = Math.floor(val / 4);
            const ring = val % 4; 
            
            // Grid Topology
            if (ring > 0) n.push(id - 1); else n.push(0); // Inward
            if (ring < 3) n.push(id + 1); // Outward
            if (ray > 0) n.push(id - 4); // Lateral Up
            if (ray < 4) n.push(id + 4); // Lateral Down
            return n;
        }

        function getSpiderNodePos(id) {
            // Canvas: 650w x 550h
            // Vertex (0) at Right Middle
            const cx = 600; 
            const cy = 275; 
            
            if (id === 0) return { x: cx, y: cy };

            const val = id - 1;
            const ray = Math.floor(val / 4); // 0..4
            const ring = val % 4;            // 0..3

            // DISTANCE (Length of Cone):
            // Max width available is ~600px. 
            // 4 rings * 120px = 480px length. Leaves padding on left.
            const dist = 100 + (ring * 120); 

            // ANGLE (Spread of Cone):
            // We need to fit the vertical height (550px).
            // Ray 2 is center (Math.PI).
            // Reduced step to 0.25 radians to prevent vertical clipping.
            const baseAngle = Math.PI; 
            const angleStep = 0.28; 
            const angle = baseAngle + ((ray - 2) * angleStep);
            
            return { x: cx + (dist * Math.cos(angle)), y: cy + (dist * Math.sin(angle)) };
        }

        function spiderInit() {
            spiderState = { player: 12, spider: 4, moves: 15, over: false }; 
            document.getElementById('spider-status').innerText = "Your Turn. Click a connected node.";
            document.getElementById('spider-status').className = "text-slate-300 font-mono text-lg";
            document.getElementById('spider-moves').innerText = "15";
            document.getElementById('spider-solution').classList.add('hidden');
            spiderRender();
        }

        function spiderClick(e) {
            if (spiderState.over) return;
            const rect = document.getElementById('spider-canvas').getBoundingClientRect();
            const scaleX = document.getElementById('spider-canvas').width / rect.width;
            const scaleY = document.getElementById('spider-canvas').height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            let clicked = -1;
            // Use calculated pos for hit detection to match drawing
            const centerPos = getSpiderNodePos(0);
            if(Math.sqrt((x-centerPos.x)**2 + (y-centerPos.y)**2) < 25) clicked = 0;
            else {
                for (let i = 1; i <= 20; i++) {
                    const pos = getSpiderNodePos(i);
                    const dist = Math.sqrt((x - pos.x)**2 + (y - pos.y)**2);
                    if (dist < 25) clicked = i;
                }
            }

            if (clicked !== -1) {
                const neighbors = getSpiderNeighbors(spiderState.player);
                if (neighbors.includes(clicked)) {
                    spiderState.player = clicked;
                    playSound(200);
                    if (spiderState.player === spiderState.spider) { spiderWin(); } else {
                        spiderState.moves--;
                        document.getElementById('spider-moves').innerText = spiderState.moves;
                        if (spiderState.moves === 0) { spiderFail(); } else { setTimeout(spiderMoveAI, 300); }
                    }
                    spiderRender();
                }
            }
        }

        function spiderMoveAI() {
            if (spiderState.over) return;
            const neighbors = getSpiderNeighbors(spiderState.spider);
            let bestMove = -1;
            let maxDist = -1;
            
            neighbors.forEach(n => {
                const pPos = getSpiderNodePos(spiderState.player);
                const nPos = getSpiderNodePos(n);
                const dist = Math.sqrt((pPos.x - nPos.x)**2 + (pPos.y - nPos.y)**2);
                if(n !== spiderState.player) {
                    if (dist > maxDist) { maxDist = dist; bestMove = n; }
                }
            });
            if(bestMove === -1) bestMove = neighbors[0]; 
            spiderState.spider = bestMove;
            playSound(100, 'triangle');
            if (spiderState.player === spiderState.spider) { spiderWin(); }
            spiderRender();
        }

        function spiderWin() {
            spiderState.over = true;
            document.getElementById('spider-status').innerText = "CAUGHT! You cornered the fly.";
            document.getElementById('spider-status').className = "text-emerald-400 font-bold text-xl";
            playSound(600);
            const movesUsed = 15 - spiderState.moves;
            const isOptimal = (movesUsed <= 10);
            sendData('Spider', 'Win', `${movesUsed} moves`, isOptimal);
            markComplete('spider', isOptimal);
        }

        function spiderFail() {
            spiderState.over = true;
            document.getElementById('spider-status').innerText = "The Fly buzzed away! Better luck next time.";
            document.getElementById('spider-status').className = "text-rose-400 font-bold";
            playSound(150, 'sawtooth');
            sendData('Spider', 'Fail', '-', false);
            setTimeout(spiderInit, 3000);
        }

        function spiderGiveUp() {
            spiderInit();
            updateStatus('spider-status', "GAVE UP. Game Reset.");
            playSound(150,'sawtooth');
            sendData('Spider', 'GiveUp', '-', false);
        }

        function spiderRender() {
            const cvs = document.getElementById('spider-canvas');
            const ctx = cvs.getContext('2d');
            ctx.clearRect(0, 0, cvs.width, cvs.height);
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#475569';
            
            // 1. Draw Rays
            // Rays are defined by the outer nodes (Ring 3, indices: n*4 + 4)
            // Indices: 4, 8, 12, 16, 20
            for (let r = 0; r < 5; r++) {
                const s = getSpiderNodePos(0); 
                const e = getSpiderNodePos((r * 4) + 4); 
                ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(e.x, e.y); ctx.stroke();
            }

            // 2. Draw Lateral Arcs
            for(let i=1; i<=20; i++) {
                const neighbors = getSpiderNeighbors(i);
                const s = getSpiderNodePos(i);
                neighbors.forEach(n => {
                    // Lateral connection if diff is 4 (same ring, different ray)
                    if(Math.abs(n-i) === 4 && n > i) { 
                        const e = getSpiderNodePos(n);
                        ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(e.x, e.y); ctx.stroke();
                    }
                });
            }

            // 3. Draw Nodes
            const center = getSpiderNodePos(0);
            ctx.beginPath(); ctx.arc(center.x, center.y, 8, 0, 2 * Math.PI); ctx.fillStyle = '#e2e8f0'; ctx.fill();
            
            for (let i = 1; i <= 20; i++) { 
                const p = getSpiderNodePos(i); 
                ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, 2 * Math.PI); ctx.fillStyle = '#94a3b8'; ctx.fill(); 
            }
            
            // Player
            const pp = getSpiderNodePos(spiderState.player);
            ctx.beginPath(); ctx.arc(pp.x, pp.y, 14, 0, 2*Math.PI); ctx.fillStyle = '#3b82f6'; ctx.fill(); ctx.strokeStyle = 'white'; ctx.lineWidth=2; ctx.stroke();

            // Prey
            const sp = getSpiderNodePos(spiderState.spider);
            ctx.beginPath(); ctx.arc(sp.x, sp.y, 14, 0, 2*Math.PI); ctx.fillStyle = '#f472b6'; ctx.fill(); ctx.strokeStyle = 'white'; ctx.lineWidth=2; ctx.stroke();
        }
        
        // Ensure event listener is fresh
        const spCanvas = document.getElementById('spider-canvas');
        const newCanvas = spCanvas.cloneNode(true);
        spCanvas.parentNode.replaceChild(newCanvas, spCanvas);
        newCanvas.addEventListener('mousedown', spiderClick);

        /* --- GAME 6: GRAPH DELIVERY (Optimal = 0 Backtrack, Immediate Reset) --- */
        let graphState={nodes:{},edges:[],current:null,visitedEdges:new Set(),over:false,path:[], clicks: 0, backtracks: 0};
        function graphInit(){
            graphState.clicks = 0;
            graphState.backtracks = 0;
            graphState.nodes = { 
                1: {x:275, y:50}, 
                2: {x:175, y:130}, 3: {x:375, y:130}, 
                4: {x:175, y:230}, 5: {x:375, y:230}, 
                6: {x:175, y:330}, 7: {x:375, y:330}, 
                8: {x:275, y:410}
            };
            graphState.edges = [
                {u:1,v:2}, {u:1,v:3}, {u:2,v:3}, 
                {u:2,v:4}, {u:2,v:5}, {u:3,v:4}, {u:3,v:5}, {u:4,v:5}, 
                {u:4,v:6}, {u:5,v:7}, {u:6,v:7}, {u:6,v:8}, {u:7,v:8}
            ];
            graphState.current = null; graphState.visitedEdges = new Set(); graphState.over = false; graphState.path = [];
            document.getElementById('graph-status').innerText = "Click a starting node (Yellow).";
            document.getElementById('graph-status').className = "text-slate-300 font-mono text-lg";
            document.getElementById('graph-left').innerText = "13";
            document.getElementById('graph-solution').classList.add('hidden');
            graphRender();
        }
        function graphClick(e) {
            const rect = document.getElementById('graph-canvas').getBoundingClientRect();
            const scaleX = document.getElementById('graph-canvas').width / rect.width;
            const scaleY = document.getElementById('graph-canvas').height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            let clickedNode = null;
            for(let id in graphState.nodes) { const n = graphState.nodes[id]; if(Math.sqrt((x-n.x)**2 + (y-n.y)**2) < 30) clickedNode = parseInt(id); }
            
            if(clickedNode !== null) {
                if(graphState.current === null) {
                    graphState.current = clickedNode; graphState.path.push(clickedNode); playSound(200);
                } 
                else if (graphState.path.length > 1 && clickedNode === graphState.path[graphState.path.length - 2]) {
                    graphState.clicks++;
                    graphState.backtracks++; // Track backtracking
                    const u = Math.min(graphState.current, clickedNode);
                    const v = Math.max(graphState.current, clickedNode);
                    const edgeIdx = graphState.edges.findIndex(e => e.u===u && e.v===v);
                    if(edgeIdx > -1 && graphState.visitedEdges.has(edgeIdx)) {
                         graphState.visitedEdges.delete(edgeIdx);
                         graphState.path.pop(); 
                         graphState.current = clickedNode; 
                         graphState.over = false; 
                         const left = 13 - graphState.visitedEdges.size;
                         document.getElementById('graph-left').innerText = left;
                         document.getElementById('graph-status').innerText = "Backtracked.";
                         playSound(150, 'sine');
                    }
                }
                else if (!graphState.over) {
                    graphState.clicks++;
                    const u = Math.min(graphState.current, clickedNode); const v = Math.max(graphState.current, clickedNode);
                    const edgeIdx = graphState.edges.findIndex(e => e.u===u && e.v===v);
                    if(edgeIdx > -1 && !graphState.visitedEdges.has(edgeIdx)) {
                        graphState.visitedEdges.add(edgeIdx); graphState.current = clickedNode; graphState.path.push(clickedNode); playSound(100, 'triangle');
                        const left = 13 - graphState.visitedEdges.size; document.getElementById('graph-left').innerText = left;
                        if(left === 0) { 
                            graphState.over = true; 
                            // Optimal: No backtracks
                            const isOptimal = (graphState.backtracks === 0);
                            document.getElementById('graph-status').innerText = isOptimal ? "PERFECT! 0 Backtracks." : "VICTORY! Route Found.";
                            document.getElementById('graph-status').className = "text-emerald-400 font-bold text-xl"; 
                            playSound(600); 
                            sendData('Delivery', 'Win', `${graphState.clicks} clicks`, isOptimal); 
                            markComplete('graph', isOptimal); 
                        }
                        else {
                            const hasMoves = graphState.edges.some((e, i) => !graphState.visitedEdges.has(i) && (e.u===graphState.current || e.v===graphState.current));
                            if(!hasMoves) { graphState.over = true; document.getElementById('graph-status').innerText = "STUCK! No unvisited streets."; document.getElementById('graph-status').className = "text-rose-400 font-bold"; playSound(150, 'sawtooth'); sendData('Delivery', 'Fail', `Left ${left}`, false); }
                        }
                    }
                }
                graphRender();
            }
        }
        function graphRender() {
            const cvs = document.getElementById('graph-canvas'); const ctx = cvs.getContext('2d'); ctx.clearRect(0,0,cvs.width,cvs.height);
            ctx.lineWidth = 5;
            graphState.edges.forEach((e, i) => {
                const n1 = graphState.nodes[e.u]; const n2 = graphState.nodes[e.v];
                ctx.beginPath(); ctx.moveTo(n1.x, n1.y); ctx.lineTo(n2.x, n2.y);
                ctx.strokeStyle = graphState.visitedEdges.has(i) ? '#10b981' : '#475569'; ctx.stroke();
            });
            for(let id in graphState.nodes) {
                const n = graphState.nodes[id];
                ctx.beginPath(); ctx.arc(n.x, n.y, 18, 0, 2*Math.PI);
                ctx.fillStyle = parseInt(id)===graphState.current ? '#fbbf24' : '#3b82f6';
                if(graphState.current === null) ctx.fillStyle = '#fbbf24';
                if(graphState.over && document.getElementById('graph-status').innerText.includes('GAVE UP') && (parseInt(id)===6 || parseInt(id)===7)) { ctx.strokeStyle = '#34d399'; ctx.lineWidth = 4; ctx.stroke(); }
                ctx.fill(); ctx.fillStyle = 'white'; ctx.font = '16px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(id, n.x, n.y);
            }
        }
        function graphGiveUp() {
            graphInit();
            updateStatus('graph-status', "GAVE UP. Game Reset.");
            playSound(150, 'sawtooth');
            sendData('Delivery', 'GiveUp', '-', false);
        }
        document.getElementById('graph-canvas').addEventListener('mousedown', graphClick);

        /* --- GAME 7: 12 BALLS (Hidden Info -> 4s Delay) --- */
        const ballsState={available:[],left:[],right:[],limit:3,cf:null,weighing:false,over:false};
        function ballsInit(){
            ballsState.available=Array.from({length:12},(_,i)=>({id:i+1}));
            ballsState.left=[];ballsState.right=[];ballsState.limit=3;ballsState.weighing=false;ballsState.over=false;
            ballsState.cf={id:Math.floor(Math.random()*12)+1,status:Math.random()>0.5?'Heavy':'Light'};
            document.getElementById('balls-logs').innerHTML='';
            updateStatus('balls-result-box', "Place balls to weigh.");
            document.getElementById('balls-guess-id').innerHTML='<option value="">Ball #</option>'+Array.from({length:12},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('');
            document.getElementById('balls-guess-status').value="";
            ballsRender();
        }
        function ballsMove(id){
            if(ballsState.weighing||ballsState.over)return;
            let p=ballsState.available,l=ballsState.left,r=ballsState.right;
            let idx=p.findIndex(b=>b.id===id);if(idx>-1){l.push(p.splice(idx,1)[0]);playSound(200);ballsRender();return}
            idx=l.findIndex(b=>b.id===id);if(idx>-1){r.push(l.splice(idx,1)[0]);playSound(200);ballsRender();return}
            idx=r.findIndex(b=>b.id===id);if(idx>-1){p.push(r.splice(idx,1)[0]);playSound(200);ballsRender();return}
        }
        function ballsRender(){
            const d=(arr,el)=>{el.innerHTML=arr.sort((a,b)=>a.id-b.id).map(b=>`<div class="ball" onclick="ballsMove(${b.id})">${b.id}</div>`).join('')};
            d(ballsState.available,document.getElementById('balls-pool'));
            d(ballsState.left,document.getElementById('balls-pan-left'));
            d(ballsState.right,document.getElementById('balls-pan-right'));
            document.getElementById('balls-left-count').innerText=ballsState.left.length;
            document.getElementById('balls-right-count').innerText=ballsState.right.length;
            document.getElementById('balls-weighs-left').innerText=`Left: ${ballsState.limit}`;
            document.getElementById('balls-btn-weigh').disabled=ballsState.limit===0||(ballsState.left.length===0 && ballsState.right.length===0)||ballsState.weighing||ballsState.over
        }
        function ballsWeigh(){
            if(ballsState.limit<=0)return;
            ballsState.weighing=true; ballsState.limit--; ballsRender();
            const b=document.getElementById('balls-result-box');
            b.className="scale-result bg-indigo-900 text-indigo-200 p-3 rounded-lg font-bold border border-indigo-500";
            b.innerText="Weighing...";
            let li=ballsState.left.map(x=>x.id),ri=ballsState.right.map(x=>x.id);
            let res="Balanced"; let cls="";
            if (ballsState.left.length > ballsState.right.length) { res = "Left Heavy"; cls = "left-heavy bg-rose-900/50 text-rose-200 border-rose-500"; } 
            else if (ballsState.right.length > ballsState.left.length) { res = "Right Heavy"; cls = "right-heavy bg-rose-900/50 text-rose-200 border-rose-500"; } 
            else {
                if(li.includes(ballsState.cf.id)) res=ballsState.cf.status==="Heavy"?"Left Heavy":"Right Heavy";
                else if(ri.includes(ballsState.cf.id)) res=ballsState.cf.status==="Heavy"?"Right Heavy":"Left Heavy";
                if(res.includes("Left")) cls="left-heavy bg-rose-900/50 text-rose-200 border-rose-500";
                else if(res.includes("Right")) cls="right-heavy bg-rose-900/50 text-rose-200 border-rose-500";
                else cls="bg-emerald-900/50 text-emerald-200 border-emerald-500";
            }
            setTimeout(()=>{b.className=`scale-result p-3 rounded-lg font-bold border-2 ${cls}`;b.innerText=res.toUpperCase();playSound(res==="Balanced"?400:200,res==="Balanced"?'sine':'sawtooth');ballsLog(li,ri,res)},800);
            setTimeout(()=>{ballsState.available.push(...ballsState.left,...ballsState.right);ballsState.left=[];ballsState.right=[];ballsState.weighing=false;ballsRender();b.className="scale-result bg-slate-700 text-center p-3 rounded-lg font-bold text-slate-200 mb-4 border border-slate-600";b.innerText="Place balls to weigh."},3500)
        }
        function ballsLog(l,r,res){const d=document.createElement('div');d.className="p-3 mb-2 rounded bg-slate-800 border-l-4 "+(res.includes("Balanced")?"border-emerald-500":"border-rose-500");d.innerHTML=`<div class="flex justify-between font-bold text-xs text-slate-400"><span>Weighing ${3-ballsState.limit}</span><span>${res}</span></div><div class="text-sm text-slate-200 mt-1">L:[${l}] vs R:[${r}]</div>`;document.getElementById('balls-logs').prepend(d)}
        function ballsCheck(){const i=parseInt(document.getElementById('balls-guess-id').value);const s=document.getElementById('balls-guess-status').value;if(!i||!s)return updateStatus('balls-result-box', "Pick Ball & Status", true);ballsState.over=true;ballsRender();const w=(i===ballsState.cf.id&&s===ballsState.cf.status);const b=document.getElementById('balls-result-box');b.className=w?"scale-result bg-emerald-600 text-white p-4 rounded-xl font-bold text-xl":"scale-result bg-red-600 text-white p-4 rounded-xl font-bold text-xl";b.innerHTML=w?"VICTORY!":"WRONG.";playSound(w?600:100,w?'sine':'sawtooth');sendData('12 Balls', 'Win', '-', true); markComplete('balls', true);}
        function ballsGiveUp(){ 
            ballsState.over=true; ballsRender(); 
            const b=document.getElementById('balls-result-box'); 
            b.className="scale-result bg-slate-600 text-white p-4 rounded-xl font-bold"; 
            b.innerHTML=`Answer: Ball ${ballsState.cf.id} is ${ballsState.cf.status}.`; 
            sendData('12 Balls', 'GiveUp', '-', false); 
            setTimeout(() => { ballsInit(); }, 4000);
        }

        /* --- GAME 8: HORSES (Hidden Info -> 4s Delay) --- */
        let horseState={pool:[],track:[],races:0,speeds:{}};
        function horseInit(){
            horseState.pool=Array.from({length:25},(_,i)=>i+1);
            horseState.track=[];horseState.races=0;
            const s=Array.from({length:25},(_,i)=>i+1);
            for(let i=s.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[s[i],s[j]]=[s[j],s[i]]}
            horseState.speeds={};for(let i=1;i<=25;i++)horseState.speeds[i]=s[i-1];
            document.getElementById('horse-logs').innerHTML='<p class="text-slate-600 italic text-center mt-10">No races yet.</p>';
            document.getElementById('horse-race-count').innerText='Races: 0';
            document.getElementById('horse-final-msg').innerText='';
            ['h-pred-1','h-pred-2','h-pred-3'].forEach(id=>document.getElementById(id).value='');
            updateStatus('horse-status', "Ready");
            horseRenderGridStructure();horseRender();
        }
        function horseRenderGridStructure(){const g=document.getElementById('horse-grid');g.innerHTML='';['A','B','C','D','E'].forEach(row=>{let html=`<div class="grid grid-cols-6 gap-1"><div class="flex items-center justify-center font-bold text-slate-500 text-xs">${row}</div>`;for(let i=0;i<5;i++)html+=`<div id="grid-${row}-${i}" class="grid-slot" ondrop="horseDrop(event, 'grid-${row}-${i}')" ondragover="allowDrop(event)"></div>`;html+='</div>';g.innerHTML+=html})}
        function allowDrop(ev){ev.preventDefault()}
        function horseDrag(ev,id){ev.dataTransfer.setData("text",id)}
        function horseDrop(ev,targetId){
            ev.preventDefault();const id=parseInt(ev.dataTransfer.getData("text"));if(!id)return;
            const poolIdx=horseState.pool.indexOf(id);if(poolIdx>-1)horseState.pool.splice(poolIdx,1);
            const trackIdx=horseState.track.indexOf(id);if(trackIdx>-1)horseState.track.splice(trackIdx,1);
            document.querySelectorAll('.horse-in-grid').forEach(el=>{if(parseInt(el.innerText)===id)el.remove()});
            if(targetId==='pool')horseState.pool.push(id);
            else if(targetId==='track'){if(horseState.track.length<5)horseState.track.push(id);else horseState.pool.push(id)}
            else if(targetId.startsWith('grid-')){
                const slot=document.getElementById(targetId);
                if(slot.children.length>0)horseState.pool.push(parseInt(slot.children[0].innerText));
                horseRender();
                const hDiv=document.createElement('div');hDiv.className="horse horse-in-grid";hDiv.draggable=true;hDiv.innerText=id;hDiv.ondragstart=(e)=>horseDrag(e,id);hDiv.onclick=()=>horseReturnFromGrid(id);
                slot.innerHTML='';slot.appendChild(hDiv);return
            }
            horseRender()
        }
        function horseReturnFromGrid(id) { document.querySelectorAll('.horse-in-grid').forEach(el => { if (parseInt(el.innerText) === id) el.remove(); }); horseState.pool.push(id); playSound(200); horseRender(); }
        function horseToggleTrack(id){
            const poolIdx=horseState.pool.indexOf(id);
            if(poolIdx>-1){if(horseState.track.length<5){horseState.pool.splice(poolIdx,1);horseState.track.push(id);playSound(200)}else updateStatus('horse-status', "Track Full!", true)}
            else{const trackIdx=horseState.track.indexOf(id);if(trackIdx>-1){horseState.track.splice(trackIdx,1);horseState.pool.push(id);playSound(200)}}
            horseRender()
        }
        function horseRender(){
            const pool=document.getElementById('horse-pool');pool.innerHTML='';
            horseState.pool.sort((a,b)=>a-b).forEach(h=>{pool.innerHTML+=`<div class="horse" draggable="true" ondragstart="horseDrag(event, ${h})" onclick="horseToggleTrack(${h})">${h}</div>`});
            const track=document.getElementById('horse-track');track.innerHTML='';
            for(let i=0;i<5;i++){if(i<horseState.track.length){let h=horseState.track[i];track.innerHTML+=`<div class="track-slot filled"><div class="horse" draggable="true" ondragstart="horseDrag(event, ${h})" onclick="horseToggleTrack(${h})">${h}</div></div>`}else{track.innerHTML+=`<div class="track-slot"></div>`}}
            document.getElementById('horse-btn-race').disabled=horseState.track.length<2
        }
        function horseRace(){
            if(horseState.track.length<2)return;
            horseState.races++;
            document.getElementById('horse-race-count').innerText=`Races: ${horseState.races}`;
            const racers=[...horseState.track];
            racers.sort((a,b)=>horseState.speeds[a]-horseState.speeds[b]);
            const l=document.getElementById('horse-logs');
            l.innerHTML=`<div class="bg-slate-800 p-2 rounded mb-2 border-l-4 border-pink-500"><div class="text-pink-400 font-bold text-xs mb-1">Race #${horseState.races}</div><div class="flex flex-wrap gap-2 text-xs text-white">${racers.map((h,i)=>`<span class="${i===0?'text-emerald-400 font-bold':''}">${i+1}. #${h}</span>`).join('<span class="text-slate-500 mx-1">></span>')}</div></div>`+l.innerHTML;
            playSound(400,'triangle');
            horseState.pool.push(...horseState.track);horseState.track=[];horseRender()
        }
        function horseCheck(){
            const p1=parseInt(document.getElementById('h-pred-1').value),p2=parseInt(document.getElementById('h-pred-2').value),p3=parseInt(document.getElementById('h-pred-3').value);
            if(!p1||!p2||!p3)return updateStatus('horse-final-msg', "Enter top 3 predictions.", true);
            const all=[];for(let i=1;i<=25;i++)all.push({id:i,s:horseState.speeds[i]});all.sort((a,b)=>a.s-b.s);
            const msg=document.getElementById('horse-final-msg');
            if(p1===all[0].id&&p2===all[1].id&&p3===all[2].id){
                if (horseState.races <= 7) { msg.className="text-emerald-400 mt-2";msg.innerText=`PERFECT! Top 3 found in ${horseState.races} races (Optimised).`;playSound(800); sendData('25 Horses', 'Win', horseState.races, true); markComplete('horses', true); } 
                else { msg.className="text-yellow-400 mt-2";msg.innerText=`Correct horses, but inefficient (${horseState.races} races). Can you do it in 7?`;playSound(600); sendData('25 Horses', 'Win', horseState.races, false); markComplete('horses', false); }
            } else { msg.className="text-rose-400 mt-2";msg.innerText=`WRONG.`;playSound(150,'sawtooth'); sendData('25 Horses', 'Fail', '-', false);}
        }
        function horseGiveUp(){
            const all=[];for(let i=1;i<=25;i++)all.push({id:i,s:horseState.speeds[i]});all.sort((a,b)=>a.s-b.s);
            const msg=document.getElementById('horse-final-msg'); 
            msg.className="text-slate-400 mt-2"; 
            msg.innerHTML = `Answer: Top 3 are #${all[0].id}, #${all[1].id}, #${all[2].id}.`; 
            playSound(150,'sawtooth'); 
            sendData('25 Horses', 'GiveUp', '-', false);
            setTimeout(() => { horseInit(); }, 4000);
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            updateAuthUI();
            renderSidebar(); 
            jugInit(); bulbInit(); catInit(); riverInit(); spiderInit(); graphInit(); ballsInit(); horseInit();
            switchTab('about'); 
        });
    </script>
</body>
</html>

